<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karol’s 3D‑printed Airports – Interactive Map</title>
  <meta name="description" content="Interactive world map of Karol’s 3D‑printed airports with details and MakerWorld links. Includes continent filter and upcoming airports layer." />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    :root { --bg:#0b1020; --panel:#12172b; --text:#e9edf5; --muted:#a6b0cf; --accent:#6aa0ff; }
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial}
    .app{display:grid;grid-template-rows:auto 1fr;height:100%;min-height:100vh}
    header{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:.9rem 1rem;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0));border-bottom:1px solid rgba(255,255,255,.08)}
    header h1{font-size:1.05rem;margin:0;letter-spacing:.2px}
    header .meta{font-size:.9rem;color:var(--muted)}
    .controls{display:flex;gap:.5rem;align-items:center}
    .controls input[type="search"], .controls select{background:var(--panel);color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:.45rem .7rem}
    .controls input[type="search"]{width:22ch}
    .controls button{background:var(--panel);color:var(--text);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:.45rem .7rem;cursor:pointer}
    .controls button:hover{border-color:var(--accent)}
    #map{height:100%;width:100%;min-height:80vh}

    .leaflet-popup-content-wrapper{background:var(--panel);color:var(--text);border-radius:12px}
    .leaflet-popup-tip{background:var(--panel)}
    .popup h3{margin:.2rem 0 .4rem;font-size:1rem}
    .popup .sub{color:var(--muted);font-size:.9rem;margin-bottom:.35rem}
    .popup a{color:var(--accent);text-decoration:none}
    .popup a:hover{text-decoration:underline}
    .badge{display:inline-block;padding:.15rem .45rem;border:1px solid rgba(255,255,255,.18);border-radius:999px;font-size:.75rem;color:var(--muted);margin-right:.35rem}
    .footer{position:absolute;right:10px;bottom:12px;background:rgba(18,23,43,.8);color:var(--muted);padding:.35rem .6rem;border-radius:8px;font-size:.8rem;z-index:400}

    .legend{background:rgba(18,23,43,.85);color:var(--text);padding:.5rem .7rem;border-radius:8px;font-size:.85rem;line-height:1.2;border:1px solid rgba(255,255,255,.1)}
    .legend-row{display:flex;align-items:center;gap:.5rem;margin:.2rem 0}
    .legend-swatch{width:14px;height:22px;border-radius:3px;display:inline-block;border:1px solid rgba(0,0,0,.35);box-shadow:0 1px 0 rgba(255,255,255,.35) inset}
    .swatch-blue{background:#2A81CB}
    .swatch-red{background:#d63e2a}

    .panel-open body{overflow:hidden}
    #info-panel{position:fixed;top:0;right:0;height:100vh;width:min(420px,92vw);background:var(--panel);color:var(--text);box-shadow:-12px 0 30px rgba(0,0,0,.35);transform:translateX(100%);transition:transform .28s ease;z-index:1000;border-left:1px solid rgba(255,255,255,.08)}
    #info-panel.open{transform:translateX(0)}
    #info-panel .panel-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08)}
    #info-panel h2{font-size:1.05rem;margin:0}
    #p-close{background:transparent;border:1px solid rgba(255,255,255,.15);color:var(--text);border-radius:10px;padding:.25rem .55rem;cursor:pointer}
    #p-close:hover{border-color:var(--accent)}
    #info-panel .panel-body{padding:12px 14px}
    .p-sub{color:var(--muted);margin:.25rem 0 .5rem}
    .p-badges{margin:.35rem 0 .6rem}
    .p-note{color:var(--muted);font-size:.9rem;margin:.3rem 0 .8rem}

    body.light{--bg:#f6f7fb;--panel:#ffffff;--text:#0e132a;--muted:#5b678a;--accent:#326dff}
    body.light .legend{background:rgba(255,255,255,.9);border-color:rgba(0,0,0,.06)}
    .p-image{border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.12);margin:.5rem 0 .8rem}
    .p-image img{display:block;width:100%;height:auto}
    /* simple 2-col gallery when multiple images present */
    .p-gallery{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem}
    .p-gallery img{display:block;width:100%;height:auto;border-radius:10px;border:1px solid rgba(255,255,255,.12)}
    .p-gallery{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem}
    .p-gallery img{display:block;width:100%;height:auto;border-radius:10px;border:1px solid rgba(255,255,255,.12)}

    #errorBanner{position:fixed;top:8px;left:8px;right:8px;background:#b91c1c;color:#fff;padding:8px 12px;border-radius:8px;z-index:2000;font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;white-space:pre-wrap;display:none}
  </style>
</head>
<body>
  <pre id="errorBanner"></pre>
  <div class="app">
    <header>
      <h1>Karol’s 3D‑printed Airports</h1>
      <div class="controls">
        <input id="search" type="search" placeholder="Search: City, IATA, ICAO" />
        <select id="continent" aria-label="Filter by continent">
          <option value="all" selected>All continents</option>
          <option value="Africa">Africa</option>
          <option value="Asia">Asia</option>
          <option value="Europe">Europe</option>
          <option value="North America">North America</option>
          <option value="South America">South America</option>
          <option value="Oceania">Oceania</option>
        </select>
        <button id="reset">Reset</button>
        <button id="theme-toggle" title="Toggle light/dark">Theme</button>
      </div>
      <div class="meta">Public map · Leaflet</div>
    </header>
    <div id="map"></div>
    <!-- Info Panel (slides in on marker click) -->
    <aside id="info-panel" aria-hidden="true">
      <div class="panel-header">
        <h2 id="p-title">Airport</h2>
        <button id="p-close" aria-label="Close panel">×</button>
      </div>
      <div class="panel-body">
        <div class="p-sub" id="p-location"></div>
        <div class="p-image" id="p-image" style="display:none"></div>
        <div class="p-badges">
          <span class="badge" id="p-iata"></span>
          <span class="badge" id="p-icao"></span>
          <span class="badge" id="p-status"></span>
          <span class="badge" id="p-flag"></span>
        </div>
        <div id="p-note" class="p-note"></div>
        <p id="p-linkwrap"></p>
      </div>
    </aside>
    <div class="footer">Tip: Click any marker for details & MakerWorld link</div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // ==== Error banner (helps debug on GitHub Pages) ====
    window.addEventListener('error', function(e){
      var el=document.getElementById('errorBanner');
      if(!el) return;
      el.textContent = 'JS Error: ' + e.message + '\n' + (e.filename||'') + (e.lineno?(':'+e.lineno):'');
      el.style.display='block';
      console.error('[errorBanner]', e.message, e);
    });

// === Marker Icons (inline SVG, keine Dateien nötig) ===
function makePinSVG(color) {
  // Klassische Pin-Form mit weißem Rand + kleinem weißen Punkt in der Mitte
  return `
  <svg xmlns="http://www.w3.org/2000/svg" width="25" height="41" viewBox="0 0 25 41" aria-hidden="true">
    <!-- weicher Schatten hinter dem Pin -->
    <ellipse cx="12.5" cy="39" rx="7.5" ry="2" fill="rgba(0,0,0,.35)"></ellipse>
    <!-- Pin-Körper -->
    <path d="M12.5 1
             C6 1 1 6 1 12.5
             C1 21 12.5 34 12.5 34
             C12.5 34 24 21 24 12.5
             C24 6 19 1 12.5 1Z"
          fill="${color}" stroke="white" stroke-width="2"/>
    <!-- innerer heller Kreis -->
    <circle cx="12.5" cy="12.5" r="4.2" fill="white" fill-opacity="0.9"/>
  </svg>`;
}
function svgIcon(color){
  return L.divIcon({
    className: 'pin-icon',
    html: makePinSVG(color),
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34]
  });
}

// Blau = printed, Rot = planned
const blueIcon = svgIcon('#2A81CB');
const redIcon  = svgIcon('#d63e2a');




    // ==== Map base ====
    const map = L.map('map', { worldCopyJump: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const printedMarkers = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true });
    const plannedMarkers = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true });

    // ==== Data (restored full lists) ====
    const AIRPORTS = [
      { name: 'Adelaide', iata: 'ADL', icao: 'YPAD', city: 'Adelaide', country: 'Australia', lat: -34.9450, lng: 138.5306, makerUrl: 'https://makerworld.com/de/models/1828920-adelaide-intl-airport-ypad-adl#profileId-1952744', imageUrl: 'https://global.discourse-cdn.com/infiniteflight/original/3X/8/e/8e8831803a80bf3bceb4b725d0aff339d531ef2d.jpg' },
      { name: 'Orlando', iata: 'MCO', icao: 'KMCO', city: 'Orlando', country: 'USA', lat: 28.4312, lng: -81.3081, makerUrl: 'https://makerworld.com/de/models/1828907-orlando-intl-airport-kmco-mco#profileId-1952728', imageUrl: 'https://s28477.pcdn.co/wp-content/uploads/2020/06/MCO_2-984x554.jpg' },
      { name: 'Farmingdale – Republic', iata: 'FRG', icao: 'KFRG', city: 'Farmingdale, NY', country: 'USA', lat: 40.7288, lng: -73.4134, makerUrl: 'https://makerworld.com/de/models/1828845-republic-airport-kfrg-frg#profileId-1952656', imageUrl: 'https://cdn.jetphotos.com/full/1/20477_1113938183.jpg' },
      { name: 'New York – John F. Kennedy', iata: 'JFK', icao: 'KJFK', city: 'New York', country: 'USA', lat: 40.6413, lng: -73.7781, makerUrl: 'https://makerworld.com/de/models/1637593-new-york-intl-airport-kjfk-jfk#profileId-1730048', imageUrl: 'https://cdn.jetphotos.com/full/2/63701_1209574748.jpg' },
      { name: 'Washington Dulles', iata: 'IAD', icao: 'KIAD', city: 'Washington, DC', country: 'USA', lat: 38.9531, lng: -77.4565, makerUrl: 'https://makerworld.com/de/models/1571994-washington-intl-airport-kiad-iad#profileId-1653452', imageUrl: 'https://static.wikia.nocookie.net/geofsaviation/images/e/ef/Washington_dulles_airport_satellite_image.jpg/revision/latest?cb=20240617202247' },
      { name: 'Brescia Montichiari', iata: 'VBS', icao: 'LIPO', city: 'Brescia', country: 'Italy', lat: 45.4289, lng: 10.3306, makerUrl: 'https://makerworld.com/de/models/1571987-brescia-montichiari-airport-lipo-vbs#profileId-1653442', imageUrl: '#' },
      { name: 'Seattle–Tacoma', iata: 'SEA', icao: 'KSEA', city: 'Seattle', country: 'USA', lat: 47.4502, lng: -122.3088, makerUrl: 'https://makerworld.com/de/models/1499239-seattle-intl-airport-ksea-sea#profileId-1568169', imageUrl: 'https://www.airportinformation.com/uploads/1756276866.jpg' },
      { name: 'Los Angeles', iata: 'LAX', icao: 'KLAX', city: 'Los Angeles', country: 'USA', lat: 33.9416, lng: -118.4085, makerUrl: 'https://makerworld.com/de/models/1499198-los-angeles-intl-airport-klax-lax#profileId-1568122', imageUrl: 'https://static.wikia.nocookie.net/aviation-airport/images/1/14/LAX_Aerial_View.webp/revision/latest?cb=20240609162715' },
      { name: 'Frankfurt Main', iata: 'FRA', icao: 'EDDF', city: 'Frankfurt', country: 'Germany', lat: 50.0379, lng: 8.5622, makerUrl: 'https://makerworld.com/de/models/1499159-frankfurt-intl-airport-eddf-fra#profileId-1568074', imageUrl: 'https://media.istockphoto.com/id/527203954/de/video/frankfurt-flughafen-bei-d%C3%A4mmerung-luftbild-hessen-regierungsbezirk-darmstadt-helikopter-filmen.jpg?s=640x640&k=20&c=fVBe7gDP3Ub2T2YQT7ZwEPvIsbwUE_IGsDRgBTZJGZU=' },
      { name: 'Munich', iata: 'MUC', icao: 'EDDM', city: 'Munich', country: 'Germany', lat: 48.3538, lng: 11.7861, makerUrl: 'https://makerworld.com/de/models/1433941-munich-airport-eddm-muc-runway-layout#profileId-1491535', imageUrl: 'https://mastercms.alhilalgroup.com/source/TTN/2017/02/28/201702281906211noqixw0.2gj.jpg' },
      { name: 'San Francisco', iata: 'SFO', icao: 'KSFO', city: 'San Francisco', country: 'USA', lat: 37.6213, lng: -122.3790, makerUrl: 'https://makerworld.com/de/models/1437390-san-francisco-intl-airport-ksfo-sfo#profileId-1495606', imageUrl: 'https://lsa.net/wp-content/uploads/2015/11/SFO-Oblique_980x550.jpg' },
    ];

    const PLANNED_AIRPORTS = [
      { name: 'Salt Lake City', iata: 'SLC', icao: 'KSLC', city: 'Salt Lake City', country: 'USA', lat: 40.7899, lng: -111.9791, note: 'Coming soon' },
      { name: 'Bangkok – Suvarnabhumi', iata: 'BKK', icao: 'VTBS', city: 'Bangkok', country: 'Thailand', lat: 13.6900, lng: 100.7501, note: 'Coming soon' },
      { name: 'Tokyo – Haneda', iata: 'HND', icao: 'RJTT', city: 'Tokyo', country: 'Japan', lat: 35.5494, lng: 139.7798, note: 'Coming soon' },
      { name: 'Beijing – Daxing', iata: 'PKX', icao: 'ZBAD', city: 'Beijing', country: 'China', lat: 39.5099, lng: 116.4108, note: 'Coming soon' },
      { name: 'Istanbul', iata: 'IST', icao: 'LTFM', city: 'Istanbul', country: 'Turkey', lat: 41.2622, lng: 28.7278, note: 'Coming soon' },
      { name: 'Paris – CDG', iata: 'CDG', icao: 'LFPG', city: 'Paris', country: 'France', lat: 49.0097, lng: 2.5479, note: 'Coming soon' },
      { name: 'Amsterdam – Schiphol', iata: 'AMS', icao: 'EHAM', city: 'Amsterdam', country: 'Netherlands', lat: 52.3105, lng: 4.7683, note: 'Coming soon' },
      { name: 'Hannover', iata: 'HAJ', icao: 'EDDV', city: 'Hanover', country: 'Germany', lat: 52.4611, lng: 9.6850, note: 'Coming soon' },
      { name: 'Barcelona – El Prat', iata: 'BCN', icao: 'LEBL', city: 'Barcelona', country: 'Spain', lat: 41.2971, lng: 2.0785, note: 'Coming soon' },
      { name: 'Zurich', iata: 'ZRH', icao: 'LSZH', city: 'Zurich', country: 'Switzerland', lat: 47.4647, lng: 8.5492, note: 'Coming soon' },
      { name: 'Sydney – Kingsford Smith', iata: 'SYD', icao: 'YSSY', city: 'Sydney', country: 'Australia', lat: -33.9399, lng: 151.1753, note: 'Coming soon' },
      { name: 'Singapore – Changi', iata: 'SIN', icao: 'WSSS', city: 'Singapore', country: 'Singapore', lat: 1.3644, lng: 103.9915, note: 'Coming soon' },
      { name: 'Cincinnati/Northern Kentucky', iata: 'CVG', icao: 'KCVG', city: 'Cincinnati', country: 'USA', lat: 39.0488, lng: -84.6678, note: 'Coming soon' },
      { name: 'Berlin – BER', iata: 'BER', icao: 'EDDB', city: 'Berlin', country: 'Germany', lat: 52.3667, lng: 13.5033, note: 'Coming soon' },
      { name: 'London – Heathrow', iata: 'LHR', icao: 'EGLL', city: 'London', country: 'UK', lat: 51.4700, lng: -0.4543, note: 'Coming soon' },
      { name: 'Dubai – DXB', iata: 'DXB', icao: 'OMDB', city: 'Dubai', country: 'UAE', lat: 25.2532, lng: 55.3657, note: 'Coming soon' },
      { name: 'Doha – Hamad', iata: 'DOH', icao: 'OTHH', city: 'Doha', country: 'Qatar', lat: 25.2731, lng: 51.6081, note: 'Coming soon' },
      { name: 'Malé – Velana', iata: 'MLE', icao: 'VRMM', city: 'Male', country: 'Maldives', lat: 4.1918, lng: 73.5291, note: 'Coming soon' },
      { name: 'Seoul – Incheon', iata: 'ICN', icao: 'RKSI', city: 'Seoul', country: 'South Korea', lat: 37.4602, lng: 126.4407, note: 'Coming soon' },
      { name: 'Honolulu – HNL', iata: 'HNL', icao: 'PHNL', city: 'Honolulu', country: 'USA', lat: 21.3245, lng: -157.9251, note: 'Coming soon' },
      { name: 'Toronto – Pearson', iata: 'YYZ', icao: 'CYYZ', city: 'Toronto', country: 'Canada', lat: 43.6777, lng: -79.6248, note: 'Coming soon' },
    ];

    // ==== Continent helper ====
    function getContinent(country){
      const c=(country||'').toLowerCase();
      if(/usa|united states|canada|mexico/.test(c)) return 'North America';
      if(/brazil|argentin|chile|peru|colombi|ecuador|bolivi|uruguay|paraguay/.test(c)) return 'South America';
      if(/germany|france|netherlands|italy|spain|switzerland|austria|united kingdom|uk|turkey|poland|czech|belg|denmark|norway|sweden|finland|portugal|ireland|holland/.test(c)) return 'Europe';
      if(/australia|new zealand/.test(c)) return 'Oceania';
      if(/china|japan|korea|singapore|thailand|qatar|united arab emirates|uae|maldives|istanbul|doha|dubai|beijing|tokyo|bangkok|south korea/.test(c)) return 'Asia';
      if(/egypt|kenya|nigeria|south africa|morocco|ghana|ethiopia|tanzania/.test(c)) return 'Africa';
      return 'Other';
    }

    // ==== Info panel wiring ====
    const panel = document.getElementById('info-panel');
    const pTitle = document.getElementById('p-title');
    const pLoc = document.getElementById('p-location');
    const pIata = document.getElementById('p-iata');
    const pIcao = document.getElementById('p-icao');
    const pStatus = document.getElementById('p-status');
    const pNote = document.getElementById('p-note');
    const pLinkWrap = document.getElementById('p-linkwrap');
    document.getElementById('p-close').addEventListener('click',()=>{ panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); });
    map.on('click', ()=>{ panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); });

    function showPanel(ap){
      pTitle.textContent = ap.name || 'Airport';
      pLoc.textContent   = `${ap.city||''}${ap.city?', ':''}${ap.country||''}`;
      pIata.textContent  = `IATA: ${ap.iata||'-'}`;
      pIcao.textContent  = `ICAO: ${ap.icao||'-'}`;
      pStatus.textContent= `Status: ${ap.status||'unknown'}`;
      pNote.textContent  = ap.note ? String(ap.note) : '';

      // Images: support either a single imageUrl or an array imageUrls (up to 2 shown)
      const imgWrap = document.getElementById('p-image');
      if (ap.imageUrls && Array.isArray(ap.imageUrls) && ap.imageUrls.length){
        const imgs = ap.imageUrls.slice(0,2).map(url=>{
          const tag = `<img alt="${ap.name}" src="${url}" loading="lazy" referrerpolicy="no-referrer" onerror="this.closest('.p-image').style.display='none'">`;
          return (ap.makerUrl && ap.makerUrl!=='#') ? `<a href="${ap.makerUrl}" target="_blank" rel="noopener">${tag}</a>` : tag;
        }).join('');
        imgWrap.style.display = 'block';
        imgWrap.innerHTML = `<div class="p-gallery">${imgs}</div>`;
      } else if (ap.imageUrl) {
        const tag = `<img alt="${ap.name}" src="${ap.imageUrl}" loading="lazy" referrerpolicy="no-referrer" onerror="this.closest('.p-image').style.display='none'">`;
        imgWrap.style.display = 'block';
        imgWrap.innerHTML = (ap.makerUrl && ap.makerUrl!=='#') ? `<a href="${ap.makerUrl}" target="_blank" rel="noopener">${tag}</a>` : tag;
      } else {
        imgWrap.style.display = 'none';
        imgWrap.innerHTML = '';
      }

      if (ap.makerUrl && ap.makerUrl !== '#') {
        pLinkWrap.innerHTML = `<a href="${ap.makerUrl}" target="_blank" rel="noopener">MakerWorld: Print now →</a>`;
      } else { pLinkWrap.innerHTML = ''; }
      panel.classList.add('open'); panel.setAttribute('aria-hidden','false');
    }

    // ==== Build markers ====
    const allLatLngs=[];

    AIRPORTS.forEach(ap=>{
      const m=L.marker([ap.lat,ap.lng],{icon:blueIcon});
      const link=ap.makerUrl&&ap.makerUrl!=='#'?`<a href="${ap.makerUrl}" target="_blank" rel="noopener">MakerWorld: Print now →</a>`:`<span class="badge">MakerWorld link coming soon</span>`;
      const popup=`<div class="popup"><h3>${ap.name}</h3><div class="sub">${ap.city}, ${ap.country}</div><div style="margin:.35rem 0 .5rem;"><span class="badge">IATA: ${ap.iata}</span><span class="badge">ICAO: ${ap.icao}</span><span class="badge">Status: printed</span></div>${link}</div>`;
      m.bindPopup(popup); m.apData={...ap,status:'printed',continent:getContinent(ap.country)};
      printedMarkers.addLayer(m); m.on('click',()=>showPanel(m.apData));
      allLatLngs.push([ap.lat,ap.lng]);
    });

    PLANNED_AIRPORTS.forEach(ap=>{
      const m=L.marker([ap.lat,ap.lng],{icon:redIcon});
      const note=ap.note?`<div class="sub" style="margin-top:.2rem">${ap.note}</div>`:'';
      const popup=`<div class="popup"><h3>${ap.name}</h3><div class="sub">${ap.city}, ${ap.country}</div><div style="margin:.35rem 0 .5rem;"><span class="badge">IATA: ${ap.iata}</span><span class="badge">ICAO: ${ap.icao}</span><span class="badge">Status: planned</span></div><span class="badge">Coming soon</span>${note}</div>`;
      m.bindPopup(popup); m.apData={...ap,status:'planned',continent:getContinent(ap.country)};
      plannedMarkers.addLayer(m); m.on('click',()=>showPanel(m.apData));
      allLatLngs.push([ap.lat,ap.lng]);
    });

    map.addLayer(printedMarkers);
    map.addLayer(plannedMarkers);

    // ==== Fit & legend & layers ====
    if(allLatLngs.length) map.fitBounds(allLatLngs,{padding:[30,30]}); else map.setView([20,0],2);

    const Legend=L.Control.extend({options:{position:'bottomleft'},onAdd:function(){const div=L.DomUtil.create('div','legend');div.innerHTML=`<div style="font-weight:600;margin-bottom:.3rem;">Legend</div><div class="legend-row"><span class="legend-swatch swatch-blue"></span> Printed (blue)</div><div class="legend-row"><span class="legend-swatch swatch-red"></span> Planned (red)</div>`;return div;}});
    map.addControl(new Legend());

    L.control.layers({}, { 'Printed (Blue)': printedMarkers, 'Planned (Red)': plannedMarkers }, { collapsed: false }).addTo(map);

    // ==== Search + Continent filter ====
    const searchInput=document.getElementById('search');
    const resetBtn=document.getElementById('reset');
    const continentSel=document.getElementById('continent');

    function rebuildLayersFrom(listPrinted,listPlanned){
      printedMarkers.clearLayers(); plannedMarkers.clearLayers();
      const bounds=[];

      listPrinted.forEach(ap=>{
        const m=L.marker([ap.lat,ap.lng],{icon:blueIcon});
        const link=(ap.makerUrl&&ap.makerUrl!=='#')
          ? `<a href="${ap.makerUrl}" target="_blank" rel="noopener">MakerWorld: Print now →</a>`
          : `<span class="badge">MakerWorld link coming soon</span>`;
        const popup=`<div class="popup"><h3>${ap.name}</h3><div class="sub">${ap.city}, ${ap.country}</div><div style="margin:.35rem 0 .5rem;"><span class="badge">IATA: ${ap.iata}</span><span class="badge">ICAO: ${ap.icao}</span><span class="badge">Status: printed</span></div>${link}</div>`;
        m.bindPopup(popup);
        printedMarkers.addLayer(m);
        m.on('click',()=>showPanel({...ap,status:'printed'}));
        bounds.push([ap.lat,ap.lng]);
      });

      listPlanned.forEach(ap=>{
        const m=L.marker([ap.lat,ap.lng],{icon:redIcon});
        const note=ap.note?`<div class="sub" style="margin-top:.2rem">${ap.note}</div>`:'';
        const popup=`<div class="popup"><h3>${ap.name}</h3><div class="sub">${ap.city}, ${ap.country}</div><div style="margin:.35rem 0 .5rem;"><span class="badge">IATA: ${ap.iata}</span><span class="badge">ICAO: ${ap.icao}</span><span class="badge">Status: planned</span></div><span class="badge">Coming soon</span>${note}</div>`;
        m.bindPopup(popup);
        plannedMarkers.addLayer(m);
        m.on('click',()=>showPanel({...ap,status:'planned'}));
        bounds.push([ap.lat,ap.lng]);
      });

      if(bounds.length) map.fitBounds(bounds,{padding:[30,30]});
    }

    function getCont(ap){ return ap.continent || getContinent(ap.country); }
    function applyFilter(term){
      const q=(term||'').trim().toLowerCase();
      const cont=(continentSel.value||'all');
      const bySearch=ap=>`${ap.name} ${ap.city} ${ap.country} ${ap.iata} ${ap.icao}`.toLowerCase().includes(q);
      const byCont=ap=>cont==='all'||getCont(ap)===cont;
      const filteredPrinted=AIRPORTS.filter(ap=>bySearch(ap)&&byCont(ap));
      const filteredPlanned=PLANNED_AIRPORTS.filter(ap=>bySearch(ap)&&byCont(ap));
      rebuildLayersFrom(filteredPrinted,filteredPlanned);
    }

    searchInput.addEventListener('input', e=>applyFilter(e.target.value));
    continentSel.addEventListener('change', ()=>applyFilter(searchInput.value));
    resetBtn.addEventListener('click', ()=>{ searchInput.value=''; continentSel.value='all'; applyFilter(''); });

    // ==== Theme toggle (optional) ====
    (function(){
      const btn=document.getElementById('theme-toggle');
      const key='airport-theme';
      const saved=localStorage.getItem(key);
      if(saved==='light') document.body.classList.add('light');
      btn.addEventListener('click',()=>{
        document.body.classList.toggle('light');
        localStorage.setItem(key, document.body.classList.contains('light')?'light':'dark');
        setTimeout(()=>map.invalidateSize(),100);
      });
    })();

    // ==== Sanity tests (console) ====
    (function(){
      try{
        console.assert(AIRPORTS.length>=1, 'AIRPORTS should not be empty');
        console.assert(PLANNED_AIRPORTS.length>=1, 'PLANNED_AIRPORTS should not be empty');
        const hasBlue = !!blueIcon && blueIcon.options && blueIcon.options.iconUrl;
        const hasRed = !!redIcon && redIcon.options && redIcon.options.iconUrl;
        console.assert(hasBlue && hasRed, 'colored icons missing');
        console.log('%cSanity checks passed','color:#22c55e');
      }catch(err){ console.warn('Sanity test failed:', err); }
    })();
  </script>
</body>
</html>
